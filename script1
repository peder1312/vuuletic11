#!/bin/bash

# =========================================
# FULL CLEAN + PTERODACTYL + WEB INSTALLER
# =========================================

# 1️⃣ Clean previous installations
echo "Cleaning previous installations..."
docker ps -aq | xargs -r docker stop
docker ps -aq | xargs -r docker rm
docker volume prune -f
docker network prune -f
rm -rf /var/www/pterodactyl
apt remove --purge -y docker.io docker-compose nginx php*
apt autoremove -y
ufw reset
ufw disable

# 2️⃣ Update system
echo "Updating system..."
apt update && apt upgrade -y
apt install -y curl wget git unzip software-properties-common sudo nano lsb-release ca-certificates apt-transport-https

# 3️⃣ Install PHP 8.2
echo "Installing PHP 8.2..."
add-apt-repository ppa:ondrej/php -y
apt update
apt install -y php8.2 php8.2-cli php8.2-fpm php8.2-mysql php8.2-xml php8.2-mbstring php8.2-bcmath php8.2-curl php8.2-gd php8.2-zip php8.2-intl php8.2-soap

update-alternatives --set php /usr/bin/php8.2
update-alternatives --set phar /usr/bin/phar8.2
update-alternatives --set phar.phar /usr/bin/phar.phar8.2
update-alternatives --set phpize /usr/bin/phpize8.2
update-alternatives --set php-config /usr/bin/php-config8.2

# 4️⃣ Install Docker + Docker Compose
echo "Installing Docker..."
apt install -y docker.io docker-compose
systemctl enable docker
systemctl start docker

# 5️⃣ Install Nginx
echo "Installing Nginx..."
apt install -y nginx
systemctl enable nginx
systemctl start nginx

# 6️⃣ Firewall setup
echo "Setting up UFW firewall..."
ufw allow OpenSSH
ufw allow 80
ufw allow 443
ufw allow 30120/tcp
ufw allow 30120/udp
ufw allow 25565/tcp
ufw enable

# 7️⃣ Setup Pterodactyl
echo "Setting up Pterodactyl Panel..."
mkdir -p /var/www/pterodactyl
cd /var/www/pterodactyl

# Download official Docker Compose file
curl -Lo docker-compose.yml https://raw.githubusercontent.com/pterodactyl/panel/develop/docker/docker-compose.yml

# Start Panel containers
docker-compose up -d

# Wait a few seconds for containers to initialize
sleep 10

# Generate Laravel key
docker exec -it $(docker ps -qf "name=pterodactyl-panel") php artisan key:generate --force

# 8️⃣ Create test web site
echo "<!DOCTYPE html><html><head><title>VPS Test</title></head><body><h1>Web hosting is working!</h1></body></html>" > /var/www/html/index.html
systemctl restart nginx

echo "=========================================="
echo "✅ INSTALL COMPLETE!"
echo "Panel: http://YOUR_VPS_IP:8080"
echo "Web test site: http://YOUR_VPS_IP"
echo "Firewall ports ready: 80,443,30120(FiveM),25565(Minecraft)"
echo "Docker, PHP 8.2, Nginx, Pterodactyl + Wings installed!"
echo "=========================================="
