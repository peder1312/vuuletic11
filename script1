#!/bin/bash
# =====================================
#  FULL HOSTING SETUP - BY VUKASIN
# =====================================

echo "ğŸ”§ Updating system..."
apt update -y && apt upgrade -y

echo "ğŸ“¦ Installing dependencies..."
apt install -y curl wget git unzip tar software-properties-common apt-transport-https ca-certificates gnupg lsb-release sudo ufw nginx php php-fpm php-mysql php-cli php-zip php-gd php-mbstring php-curl php-xml php-bcmath php-json mariadb-server docker.io docker-compose

systemctl enable nginx
systemctl enable mariadb
systemctl start nginx
systemctl start mariadb
systemctl enable docker
systemctl start docker

echo "ğŸ”¥ Setting up firewall..."
ufw allow OpenSSH
ufw allow 80
ufw allow 443
ufw allow 8080
ufw allow 30120/udp
ufw allow 30120/tcp
ufw allow 25565/tcp
ufw --force enable

echo "ğŸ›¢ï¸ Configuring MySQL..."
mysql -u root <<MYSQL_SCRIPT
CREATE DATABASE pterodactyl;
CREATE USER 'ptero'@'%' IDENTIFIED BY 'StrongPteroPass123';
GRANT ALL PRIVILEGES ON *.* TO 'ptero'@'%';
FLUSH PRIVILEGES;
MYSQL_SCRIPT

echo "ğŸŒ Installing Pterodactyl Panel via Docker..."
mkdir -p /var/www/pterodactyl
cd /var/www/pterodactyl
curl -o docker-compose.yml https://raw.githubusercontent.com/pterodactyl/panel/develop/docker-compose.yml

# Update environment file
cat > .env <<EOL
APP_URL=http://$(hostname -I | awk '{print $1}'):8080
APP_TIMEZONE=Europe/Belgrade
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=pterodactyl
DB_USERNAME=ptero
DB_PASSWORD=StrongPteroPass123
EOL

docker compose up -d

echo "ğŸ¦… Installing Pterodactyl Wings..."
mkdir -p /etc/pterodactyl
cd /etc/pterodactyl
curl -Lo wings https://github.com/pterodactyl/wings/releases/latest/download/wings_linux_amd64
chmod +x wings
mv wings /usr/local/bin/wings

cat > /etc/systemd/system/wings.service <<EOL
[Unit]
Description=Pterodactyl Wings Daemon
After=docker.service
Requires=docker.service

[Service]
User=root
WorkingDirectory=/etc/pterodactyl
LimitNOFILE=4096
PIDFile=/var/run/wings.pid
ExecStart=/usr/local/bin/wings
Restart=on-failure
StartLimitInterval=600

[Install]
WantedBy=multi-user.target
EOL

systemctl enable wings
systemctl start wings

echo "ğŸŒ Web hosting setup..."
mkdir -p /var/www/html/testsite
echo "<h1>ğŸš€ Web Hosting Radi!</h1>" > /var/www/html/testsite/index.html
chown -R www-data:www-data /var/www/html

cat > /etc/nginx/sites-available/testsite <<EOL
server {
    listen 80;
    server_name _;

    root /var/www/html/testsite;
    index index.html index.php;
}
EOL

ln -s /etc/nginx/sites-available/testsite /etc/nginx/sites-enabled/
systemctl reload nginx

echo "âœ… INSTALL COMPLETE!"
echo "----------------------------"
echo "Panel: http://$(hostname -I | awk '{print $1}'):8080"
echo "Wings installed (systemctl status wings)"
echo "Database: pterodactyl / StrongPteroPass123"
echo "Web test: http://$(hostname -I | awk '{print $1}')"
echo "Firewall ports open for FiveM, Minecraft, Discord bots, and web hosting."
echo "----------------------------"
